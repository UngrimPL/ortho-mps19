<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>Ortofotomapa — Cloudflare R2</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      background: #dfe4ea;
      font-family: system-ui, sans-serif;
    }
    .info-box {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.9);
      border-radius: 10px;
      padding: 8px 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 10;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div class="info-box">
    <b>Źródło:</b> Cloudflare R2<br>
    <b>Plik:</b> ms19.pmtiles
  </div>

  <script>
    // --- konfiguracja PMTiles ---
    const PMTILES_URL = "https://pub-ceaa84cce5f04dc9bc703ca491dfbe8a.r2.dev/ms19.pmtiles";

    const protocol = new pmtiles.Protocol();
    maplibregl.addProtocol("pmtiles", protocol.tile);
    const p = new pmtiles.PMTiles(PMTILES_URL);
    protocol.add(p);

    // --- inicjalizacja mapy ---
    const map = new maplibregl.Map({
      container: "map",
      style: {
        version: 8,
        sources: {},
        layers: []
      },
      center: [19.2, 52.0], // przykładowe centrum, zostanie dopasowane automatycznie
      zoom: 14,
      attributionControl: true
    });

    map.addControl(new maplibregl.NavigationControl(), "top-left");
    map.addControl(new maplibregl.ScaleControl({ unit: "metric" }));

    // --- po wczytaniu mapy ---
    map.on("load", async () => {
      // pobierz metadane PMTiles (bounds, zoom)
      try {
        const header = await p.getHeader();
        if (header && header.bounds) {
          const [w, s, e, n] = header.bounds;
          map.fitBounds([[w, s], [e, n]], { padding: 20 });
        }
      } catch (err) {
        console.error("Nie można odczytać nagłówka PMTiles:", err);
      }

      // dodaj źródło ortofoto z PMTiles
      map.addSource("ortho", {
        type: "raster",
        tiles: [`pmtiles://${PMTILES_URL}/{z}/{x}/{y}`],
        tileSize: 256,
        minzoom: 10,
        maxzoom: 22
      });

      // dodaj warstwę ortofoto
      map.addLayer({
        id: "ortho-layer",
        type: "raster",
        source: "ortho",
        paint: {
          "raster-opacity": 1
        }
      });
    });
  </script>
</body>
</html>
